<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="./components/box-titlebar.html">
<link rel="import" href="./components/box/box-content/box-content.html">
<link rel="import" href="./components/ui/box-button.html">
<link rel="import" href="./components/ui/box-button-group.html">

<link rel="import" href="./pages/box-page-login/box-page-login.html">
<link rel="import" href="./pages/box-page-uploader/box-page-uploader.html">

<dom-module id="box-app">

  <template>
    <style>
      :host, iron-pages {
          height: 100%;
      }
      #loading {
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.80);
          color: #fff;
      }
      #loading.hidden {
          display: none;
      }
    </style>

    <!-- APP ROUTING -->
    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}"
    ></app-route>
    <!-- /APP ROUTING -->

    <!-- STORE -->
    <iron-localstorage name="box:auth:user" value="{{user}}" on-iron-localstorage-load-empty="initializeDefaultUser"></iron-localstorage>
    <!-- /STORE -->
<!--
    <box-titlebar>
      <box-button-group>
        <box-button on-click="showUploadedList">show</box-button>
        <box-button on-click="hideUploadedList">hide</box-button>
        <box-button on-click="uploadFiles">upload</box-button>
      </box-button-group>
    </box-titlebar>
-->
    <box-content>
      <iron-pages role="main" selected="[[page]]" attr-for-selected="name">
        <box-page-login name="login"></box-page-login>
        <box-page-uploader id="uploader" name="uploader"></box-page-uploader>
      </iron-pages>
      <div id="loading">起動中</div>
    </box-content>

  </template>

  <script>
      const defaultPage = 'login';

      Polymer({
          is: 'box-app',
          properties: {
            page: {
              type: String,
              reflectToAttribute: true,
              observer: '_pageChanged'
            },
            user: Object,
          },
          initializeDefaultUser() {
            this.user = {
              uid: '',
              email: '',
              displayName: '',
            };
          },
          ready() {
              this.$$('box-page-login').addEventListener('success', user => {
                  this.page = 'uploader';
              });
              this.$$('box-page-login').addEventListener('failed', message => {

              });
              // check is logged in.
              firebase.auth().onAuthStateChanged(user => {
                // hide loading screen
                this.$.loading.classList.add('hidden');
                if (user) {
                  // User is signed in.
                  this.page = 'uploader';

                  this.set('user', {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                  });
                } else {
                  // No user is signed in.
                  this.page = 'login';
                }
              });

              // // check is logged in
              // if (! firebase.auth().currentUser) {
              //     console.log("NAIYO");
              //     // this.importHref(this.resolveUrl(`pages/${defaultPage}.html`), null, null, true);
              // } else {
              //     console.log("ARUYO");
              // //     this.importHref(this.resolveUrl('pages/login.html'), null, null, true);
              // }
          },
          observers: [
              '_routePageChanged(routeData.page)'
          ],
          _routePageChanged(page) {
              this.page = page || defaultPage;
          },
          _pageChanged(page) {
              this.page = page;
          },
          showUploadedList() {
            this.$.uploader.showUploadedList();
          },
          hideUploadedList() {
            this.$.uploader.hideUploadedList();
          },
          uploadFiles() {
            this.$.uploader.compress();
          }
      });
  </script>

</dom-module>
