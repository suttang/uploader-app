<link rel="import" href="../../components/drop-area.html">
<link rel="import" href="./box-uploaded-list.html">
<link rel="import" href="./box-file-list.html">
<link rel="import" href="./box-file-item.html">


<dom-module id="box-page-uploader">

  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        background: #f3f3f3;
      }
      strong {
          font-weight: 500;
      }
      /*
       * COLUMN MANAGEMENT
       */
      #column {
        display: flex;
        flex-direction: row;
        flex: 1;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #column box-uploaded-list {
        flex: 0 0 12em;
        margin-left: -12em;
        overflow-x: hidden;
        overflow-y: scroll;
        transition: margin 0.3s ease;
      }
      #column.showUploadedList box-uploaded-list {
        margin-left: 0;
      }
      #column box-file-list {
        flex: 1;
        overflow-x: hidden;
        overflow-y: scroll;
      }
    </style>

    <div id="column">
      <box-uploaded-list id="uploadedList"></box-uploaded-list>
      <box-file-list>
        <button on-click="compress">compress</button>
        <template is="dom-repeat" items="{{files}}">
          <box-file-item name="{{item.name}}" size="{{item.size}}">{{item.name}}</box-file-item>
        </template>
        <p>
          Drop <strong>folder</strong> or <strong>files</strong> here
        </p>
      </box-file-list>

    <!-- <box-drop-area id="uploadArea"></box-drop-area> -->

  </template>

  <script>

    class UploadFile {
      constructor(path, size, type, name, file) {
        this.path = path;
        this.size = size;
        this.type = type;
        this.name = name;
        this.file = file;
      }
      get isFile() {
        return this.type === 'file';
      }
      get isDirectory() {
        return this.type === 'directory';
      }
    }

    const electron = require('electron');
    const fs = electron.remote.require('fs');
    const FileReader = electron.remote.require('filereader');
    const FileApi = electron.remote.require('file-api');
    const archiver = electron.remote.require('archiver');
    const archive = archiver('zip');

    const uploadFiles = [];


    const {BoxArchiver} = electron.remote.require('./libs/box-archiver');
    const {BoxArchiveItem} = electron.remote.require('./libs/box-archiver');

    const arc = new BoxArchiver();



    // output.on('close', function() {
    //   console.log(archive.pointer() + ' total bytes');
    //   console.log('archiver has been finalized and the output file descriptor has closed.');
    // });
    //
    // archive.on('entry', (event) => {
    //   console.log(event.stats.size);
    // });
    // let inputBytes = 0;
    // let outputBytes = 0;
    // let isInputMode = true;
    // archive.on('data', (event) => {
    //   if (isInputMode) {
    //     inputBytes += event.length;
    //   } else {
    //     outputBytes += event.length;
    //   }
    //   // console.log(`${inputBytes} / ${outputBytes}`);
    // });
    //
    // archive.on('error', function(err) {
    //   throw err;
    // });


    Polymer({
      is: 'box-page-uploader',
      listeners: {
        dragenter: 'handleDragEnter',
        dragover: 'handleDragOver',
        dragleave: 'handleDragLeave',
        drop: 'handleDrop',
      },
      properties: {
        files: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },
      handleDragEnter(event) {
          event.preventDefault();
          console.log("DRAG OVER");
      },
      handleDragOver(event) {
          event.preventDefault();
          console.log("DRAG OVER");
      },
      handleDragLeave(event) {
          event.preventDefault();
          console.log("DRAG LELAVE");
      },
      handleDrop(event) {
        event.preventDefault();
        let index = 0;
        for (let item of event.dataTransfer.items) {
          let entry = item.webkitGetAsEntry();
          let file = event.dataTransfer.files[index];

          let type;
          if (entry.isFile) {
            type = 'file';
          } else if (entry.isDirectory) {
            type = 'directory';
          } else {
            continue;
          }
          uploadFiles.push(new UploadFile(file.path, file.size, type, file.name, file));

          this.push('files', {
            name: file.name,
            size: file.size,
          });
          index++;
        }
      },
      ready() {},

      compress() {
        const archive = archiver('zip');
        const output = fs.createWriteStream('/Users/suttang/Desktop/archive_from_archiver.zip');
        archive.pipe(output);
        for (let file of uploadFiles) {
          if (file.isFile) {
            archive.append(fs.createReadStream(file.path), { name: file.name });
          } else {
            archive.directory(file.path, file.name, file.file);
          }
        }
        archive.finalize();

        return;
        isInputMode = false;
        archive.finalize();
        //
        const storageReference = firebase.storage().ref().child('archives');



        // const File = FileApi.File;
        // console.log(storageReference);
        // console.log(FileApi);

        // 動いてない奴
        // const fileReader = new FileReader();
        // fileReader.addEventListener('load', function(event) {
        //   // const blob = new File(event.target.result, 'temp.zip');
        //   // const blob = new File([], 'temp.zip');
        //   // console.log(blob);
        //   // console.log("DONE");
        //   // console.log(event.target.result);
        //   // const blob = new Blob(event.target.result, {type: 'application/zip'});
        //   storageReference.put(blob, {contentType: 'application/zip'}).then(response => {
        //     console.log(response);
        //   }).catch(error => {
        //     cosole.log(error);
        //   });
        // });
        // fileReader.readAsArrayBuffer(new File('/Users/suttang/Desktop/config.xml.zip'));

        // 動いたやつ
        // fs.readFile('/Users/suttang/Desktop/ss.png', function(error, data) {
        //   if (error) {
        //     return console.log(error);
        //   }
        //   const blob = new Blob([data], {});
        //   storageReference.put(blob, {}).then(response => {
        //     console.log(response);
        //   }).catch(error => {
        //     cosole.log(error);
        //   });
        // });

        // storageReference.put();
        // setInterval(() => {
        //   console.log(archive.pointer() + ' total bytes');
        // }, 100);
      },
      hideUploadedList() {
        this.$.column.classList.remove('showUploadedList');
      },
      showUploadedList() {
        this.$.column.classList.add('showUploadedList');
      }
    });

  </script>

</dom-module>
