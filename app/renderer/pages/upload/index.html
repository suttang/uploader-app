<link rel="import" href="../../components/drop-area.html">
<link rel="import" href="./box-uploaded-list.html">
<link rel="import" href="./box-file-list.html">
<link rel="import" href="./box-file-item.html">


<dom-module id="box-page-uploader">

  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        background: #f3f3f3;
      }
      strong {
          font-weight: 500;
      }
      /*
       * COLUMN MANAGEMENT
       */
      #column {
        display: flex;
        flex-direction: row;
        flex: 1;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #column box-uploaded-list {
        flex: 0 0 12em;
        margin-left: -12em;
        overflow-x: hidden;
        overflow-y: scroll;
        transition: margin 0.3s ease;
      }
      #column.showUploadedList box-uploaded-list {
        margin-left: 0;
      }
      #column box-file-list {
        flex: 1;
        overflow-x: hidden;
        overflow-y: scroll;
      }
    </style>

    <div id="column">
      <box-uploaded-list id="uploadedList"></box-uploaded-list>
      <box-file-list>
        <button on-click="compress">compress</button>
        <template is="dom-repeat" items="{{files}}">
          <box-file-item name="{{item.name}}" size="{{item.size}}">{{item.name}}</box-file-item>
        </template>
        <p>
          Drop <strong>folder</strong> or <strong>files</strong> here
        </p>
      </box-file-list>

    <!-- <box-drop-area id="uploadArea"></box-drop-area> -->

  </template>

  <script>
    const electron = require('electron');
    const {BoxArchiver} = electron.remote.require('./libs/box-archiver');

    let archive = new BoxArchiver();

    Polymer({
      is: 'box-page-uploader',
      listeners: {
        dragenter: 'handleDragEnter',
        dragover: 'handleDragOver',
        dragleave: 'handleDragLeave',
        drop: 'handleDrop',
      },
      properties: {
        files: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },
      handleDragEnter(event) {
          event.preventDefault();
      },
      handleDragOver(event) {
          event.preventDefault();
      },
      handleDragLeave(event) {
          event.preventDefault();
      },
      handleDrop(event) {
        event.preventDefault();
        let index = 0;
        for (let item of event.dataTransfer.items) {
          let entry = item.webkitGetAsEntry();
          let file = event.dataTransfer.files[index];
          let type;
          if (entry.isFile) {
            type = 'file';
          } else if (entry.isDirectory) {
            type = 'directory';
          } else {
            continue;
          }

          this.pushFile(file, type);
          index++;
        }
      },
      handleArchiveComplete(archive) {
        console.log(archive.pointer());
      },
      ready() {},
      /**
       * push file to file list
       * @param  {File} file
       * @param  {String} type
       * @return {Number} length of files
       */
      pushFile(file, type) {
        archive.add(file, type);
        this.push('files', {
          name: file.name,
          size: file.size,
        });
      },
      /**
       * clear file list
       */
      clear() {
        archive.clear();
        this.splice('files', 0, this.files.length);
      },

      compress() {
        archive.once('complete', () => {
          archive.load().then(data => {
            const blob = new Blob([data], {});
            const storage = firebase.storage().ref().child('archives');
            return storage.put(blob, {});
          }).then(response => {
            console.log(response);
          }).catch(error => {
            console.log(error);
          });
          console.log("ARCHIVE CREATED");
        });
        archive.create();
      },
      hideUploadedList() {
        this.$.column.classList.remove('showUploadedList');
      },
      showUploadedList() {
        this.$.column.classList.add('showUploadedList');
      }
    });

  </script>

</dom-module>
