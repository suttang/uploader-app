<link rel="import" href="../../components/drop-area.html">
<link rel="import" href="../../components/box/box-archive-list/box-archive-list.html">
<link rel="import" href="../../components/box/box-file-list/box-file-list.html">
<link rel="import" href="../../components/box/box-button/box-button.html">
<link rel="import" href="../../components/box/box-icon/box-icon-upload.html">
<link rel="import" href="../../components/box/box-uploader-modal/box-uploader-modal.html">


<dom-module id="box-page-uploader">

  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }
      :host(.modalShown) #column {
        -webkit-filter: blur(2px);
      }
      strong {
          font-weight: 500;
      }
      /*
       * COLUMN MANAGEMENT
       */
      #column {
        display: flex;
        flex-direction: row;
        flex: 1;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #column #rightColumn {
        width: 100%;
        overflow-y: scroll;
        position: relative;
      }
      #column box-archive-list {
        flex: 0 0 18em;
        overflow-x: hidden;
        overflow-y: scroll;
      }
      #uploadButton {
        position: fixed;
        left: 50%;
        bottom: 10px;
      }
    </style>

    <div id="column">
      <box-archive-list id="uploadedList" on-select-change="uploadedSelectChanged"></box-archive-list>
      <div id="rightColumn">
        <box-file-list id="fileList"></box-file-list>
        <box-button type="primary" id="uploadButton" icon="box-icon-upload" on-click="handleUploadPressed">Upload</box-button>
      </div>
    </div>

    <box-uploader-modal id="modal"></box-uploader-modal>
  </template>

  <script>
    const electron = require('electron');
    const {BoxArchiver} = electron.remote.require('../libs/box-archiver');

    let archive = new BoxArchiver();

    Polymer({
      is: 'box-page-uploader',
      listeners: {
        dragenter: 'handleDragEnter',
        dragover: 'handleDragOver',
        dragleave: 'handleDragLeave',
        drop: 'handleDrop',
      },
      properties: {},
      handleDragEnter(event) {
          event.preventDefault();
      },
      handleDragOver(event) {
          event.preventDefault();
      },
      handleDragLeave(event) {
          event.preventDefault();
      },
      handleDrop(event) {
        event.preventDefault();
        this.$.fileList.addItemsFromDataTransfer(event.dataTransfer);
      },
      handleArchiveComplete(archive) {
        console.log(archive.pointer());
      },
      /**
       * clear file list
       */
      clear() {
        archive.clear();
        // this.splice('files', 0, this.files.length);
      },

      compress() {
        // Collect file entries
        const items = this.$.fileList.items;
        for (let item of items) {
          archive.add(item.file, item.type);
        }

        const progressHandler = (event) => {
          console.log(`${event.bytesTransferred / event.totalBytes * 100}%`);
        }

        // Archive
        archive.once('complete', () => {
          archive.load().then(data => {
            const blob = new Blob([data], {});
            const storage = firebase.storage().ref().child(archive.filename);
            const upload = storage.put(blob, {});
            upload.on('state_changed', progressHandler);
            return upload;
          }).then(response => {
            // constract database data
            const files = [];
            for (let file of archive.files) {
              files.push({
                name: file.name,
                size: file.size,
                type: file.type,
              });
            }
            // save database
            const uuid = firebase.auth().currentUser.uid;
            return firebase.database().ref(`uploads/${uuid}`).push({
              name: archive.filename,
              files: files,
              created_at: Date.now(),
            });
          }).then(response => {
            console.log("FILE UPLOAD COMPLETE");
          }).catch(error => {
            console.log(error);
          });
        });
        archive.create();
      },
      hideUploadedList() {
        this.$.column.classList.remove('showUploadedList');
        this.$.uploadedList.close();
      },
      showUploadedList() {
        this.$.column.classList.add('showUploadedList');
        this.$.uploadedList.open();
      },
      /**
       * アーカイブリストの選択が変更されたイベントのハンドラ
       * @param  {[type]} event [description]
       * @param  {[type]} items [description]
       * @return {[type]}       [description]
       */
      uploadedSelectChanged(event, items) {
        if (items.length > 1) {
          console.log('select multiple items');
          return;
        }
        const item = items[0];

        // 新規作成の場合
        if (item.id === '') {
          this.$.fileList.showNewArchive();
          return;
        }
        const archiveItem = this.$.uploadedList.getArchiveItemById(item.id);
        this.$.fileList.showArchiveItem(archiveItem);
      },
      handleUploadPressed(event) {
        Polymer.dom(this).classList.add('modalShown');
        this.$.modal.show();
        // console.log("HANDLE UPLOAD");
      }
    });

  </script>

</dom-module>
