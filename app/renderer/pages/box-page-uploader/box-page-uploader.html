<link rel="import" href="../../components/drop-area.html">
<link rel="import" href="../../components/box/box-archive-list/box-archive-list.html">
<link rel="import" href="../../components/box/box-file-list/box-file-list.html">
<link rel="import" href="../../components/box/box-button/box-button.html">
<link rel="import" href="../../components/box/box-icon/box-icon-upload.html">
<link rel="import" href="../../components/box/box-uploader-modal/box-uploader-modal.html">


<dom-module id="box-page-uploader">

  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }
      :host(.modalShown) #column {
        -webkit-filter: blur(2px);
      }
      strong {
        font-weight: 500;
      }
      /*
       * COLUMN MANAGEMENT
       */
      #column {
        display: flex;
        flex-direction: row;
        flex: 1;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #column #rightColumn {
        width: 100%;
        overflow-y: scroll;
        position: relative;
      }
      #column box-archive-list {
        flex: 0 0 18em;
        overflow-x: hidden;
        overflow-y: scroll;
      }
      /*
       * UPLOAD BUTTON
       */
      #uploadButton {
        display: none;
        position: fixed;
        left: 50%;
        bottom: 20px;
      }
      #uploadButton.show {
        display: block;
        -webkit-animation-name: show-upload-button;
        -webkit-animation-duration: 300ms;
        -webkit-transition-timing-function: cubic-bezier(.08,.34,.36,.99);
      }
      @-webkit-keyframes show-upload-button {
        0% {
          display: none;
          opacity: 0.5;
          transform: translateY(10px);
        }
        1% {
          display: block;
          opacity: 0.5;
          transform: translateY(10px);
        }
        100% {
          display: block;
          opacity: 1;
          transform: translateY(0px);
        }
      }
    </style>

    <div id="column">
      <box-archive-list id="uploadedList" on-select-change="uploadedSelectChanged"></box-archive-list>
      <div id="rightColumn">
        <box-file-list id="fileList"></box-file-list>
        <box-button type="primary" id="uploadButton" icon="box-icon-upload" on-click="handleUploadPressed">Upload</box-button>
      </div>
    </div>

    <box-uploader-modal id="modal" on-complete="handleModalCompleted" on-close="handleModalClose" on-upload-complete="handleUploadComplete"></box-uploader-modal>
  </template>

  <script>
    (() => {
      const MODE_CREATE = 'MODE_CREATE';
      const MODE_HISTORY = 'MODE_HISTORY';
      Polymer({
        is: 'box-page-uploader',
        listeners: {
          dragenter: 'handleDragEnter',
          dragover: 'handleDragOver',
          dragleave: 'handleDragLeave',
          drop: 'handleDrop',
        },
        properties: {
          mode: {
            type: String,
            value: MODE_CREATE,
          }
        },
        handleDragEnter(event) {
          event.preventDefault();
        },
        handleDragOver(event) {
          event.preventDefault();
        },
        handleDragLeave(event) {
          event.preventDefault();
        },
        handleDrop(event) {
          event.preventDefault();
          if (this.mode !== MODE_CREATE) {
            return;
          }
          this.showUploadButton();
          const files = [];
          for (let item of event.dataTransfer.files) {
            files.push(item.path);
          }
          this.$.fileList.addItems(files);
        },
        handleArchiveComplete(archive) {
          console.log(archive.pointer());
        },
        /**
         * clear file list
         */
        clear() {
          archive.clear();
          // this.splice('files', 0, this.files.length);
        },
        hideUploadedList() {
          this.$.column.classList.remove('showUploadedList');
          this.$.uploadedList.close();
        },
        showUploadedList() {
          this.$.column.classList.add('showUploadedList');
          this.$.uploadedList.open();
        },
        /**
         * アーカイブリストの選択が変更されたイベントのハンドラ
         * @param  {[type]} event [description]
         * @param  {[type]} items [description]
         * @return {[type]}       [description]
         */
        uploadedSelectChanged(event, items) {
          if (items.length > 1) {
            console.log('select multiple items');
            return;
          }
          const item = items[0];

          // 新規作成の場合
          if (item.id === '') {
            this.mode = MODE_CREATE;
            this.$.fileList.showNewArchive();
            return;
          }
          this.mode = MODE_HISTORY;
          this.hideUploadButton();

          // それ以外 (アップロード済みアイテムの選択) の場合
          const archiveItem = this.$.uploadedList.getArchiveItemById(item.id);
          this.$.fileList.showArchiveItem(archiveItem);
        },
        /**
         * アップロードボタンの表示
         * @return {[type]} [description]
         */
        showUploadButton() {
          Polymer.dom(this.$.uploadButton).classList.add('show');
        },
        /**
         * アップロードボタンの非表示
         * @return {[type]} [description]
         */
        hideUploadButton() {
          Polymer.dom(this.$.uploadButton).classList.remove('show');
        },
        handleUploadPressed(event) {
          Polymer.dom(this).classList.add('modalShown');
          this.$.modal.show();
        },
        handleUploadComplete(event, data) {
          const key = data.key;
          this.$.uploadedList.selectItem(key);
        },
        handleModalCompleted(event) {
          Polymer.dom(this).classList.remove('modalShown');
          this.$.modal.hide();
        },
        handleModalClose(event) {
          Polymer.dom(this).classList.remove('modalShown');
          this.$.modal.hide();
        }
      });
    })();
  </script>

</dom-module>
