<dom-module id="box-uploaded-list">

  <template>
    <style>
      :host {
        display: block;
        background: #f6f6f6;
        border-right: 1px solid #d1d1d1;
      }
      h1 {
        margin: 0 0 10px 0;
        padding: 0;
        line-height: 1;
        font-size: 9px;
        font-weight: 500;
      }
      #listContainer {
        width: 100%;
        border: 0px;
        outline: 0px;
        background: none;
        overflow: visible;
        -webkit-appearance: none;
      }
      select#listContainer option {
        width: 100%;
        padding: 10px 10px;
        font-size: 12px;
        appearance: none;
        -webkit-appearance: none;
      }
      select#listContainer option.context {
        font-weight: bold;
      }
      select#listContainer[multiple]:focus option:checked {
        background: red linear-gradient(0deg, red 0%, red 100%);
      }
      select#listContainer[multiple] option:checked {
        background: blue linear-gradient(0deg, blue 0%, blue 100%);
      }
    </style>

    <h1>UPLOADS</h1>
    <form id="selectedItems">
      <select multiple id="listContainer" on-change="selectChange">
        <option class="item" value="" id="" data-name="">aiueo<a href="#" style="background: #0f0">hoge</a></option>
        <template is="dom-repeat" items="{{items}}">
          <option class="item" value="{{item.key}}" id="{{item.key}}" data-name="{{item.name}}" on-contextmenu="openContextMenu">{{item.name}}</option>
        </template>
      </select>
    </form>
  </template>


  <script>
    (() => {
      // <li class="item" on-click="itemClicked" on-contextmenu="openContextMenu" id="{{item.key}}" data-name="{{item.name}}">{{item.name}}</li>
      const electron = require('electron');
      const Menu = electron.remote.Menu;
      const menu = Menu.buildFromTemplate([
        {
          label: 'Copy download URL',
          click: (item) => {
            console.log(contextMenuTargetItem);
          },
        }, {
          type: 'separator'
        }, {
          label: 'Delete',
          click: (item) => {
            const uuid = firebase.auth().currentUser.uid;
            for (let item of selectedItems) {
              const entryKey = item.id;
              const entryName = item.dataName;
              const databaseRef = firebase.database().ref(`uploads/${uuid}/${entryKey}`);
              const storageRef = firebase.storage().ref().child(entryName);

              console.info(`[STORAGE DELETE]: ${entryName}...`);
              storageRef.delete().then(() => {
                console.info('[STORAGE DELETE]: complete');
                console.info(`[DATABASE DELETE]: ${entryKey}...`);
                return databaseRef.remove();
              }).then(() => {
                console.info('[DATABASE DELETE]: complete');
              }).catch((error) => {
                alert(`ERROR\n${error}`);
              });
            }
          },
        },
      ]);

      let contextMenuTargetItem = null;
      // 選択済みのアイテム
      let selectedItems = [];

      Polymer({
        is: 'box-uploaded-list',
        properties: {
          isOpened: Boolean,
          items: {
            type: Array,
            value: function() {
              return [];
            }
          },
        },
        ready() {
          setTimeout(() => {
            const uuid = firebase.auth().currentUser.uid;
            const uploadsRef = firebase.database().ref(`uploads/${uuid}`);
            uploadsRef.on('value', (snapshot) => {
              this.refresh(snapshot.val());
            });
          }, 2000);
        },
        refresh(entries) {
          // empty
          this.splice('items', 0, this.items.length);
          // add
          for (let key in entries) {
            let entry = entries[key];
            entry.key = key;
            this.push('items', entry);
          }
        },
        openContextMenu(event) {
          event.preventDefault();
          contextMenuTargetItem = event.target;
          // contextMenuTargetItem.classList.add('context');
          // setTimeout(() => {
          menu.popup(electron.remote.getCurrentWindow());
          // }, 5);
        },
        open() {
          this.isOpened = true;
        },
        close() {
          this.isOpened = false;
        },
        selectChange() {
          selectedItems = Polymer.dom(this.root).querySelectorAll('option.item:checked');
          this.fire('select-change', selectedItems);
        },
      });

    })();
  </script>

</dom-module>
