<dom-module id="box-archive-list">

  <template>
    <style>
      :host {
        display: block;
        background: #F4F4F4;
      }
      #draggableArea {
        width: 100%;
        height: 39px;
        background: transparent;
        -webkit-user-select: none;
        -webkit-app-region: drag;
      }

      select#listContainer {
        width: 100%;
        border: 0px;
        outline: 0px;
        background: transparent;
        overflow: visible;
        color: #767D82;
        -webkit-appearance: none;
      }

      #agemaru:checked {
        color: #f00;
      }
      select#listContainer option {
        width: 100%;
        padding: 10px 10px;
        font-size: 14px;
        font-weight: 200;
        appearance: none;
        -webkit-appearance: none;
      }
      select#listContainer option.selected {
        color: #767D82;
      }
      /*
        http://jsfiddle.net/vzDvK/1/
      */
      select#listContainer[multiple]:focus option:checked {
        color: #767D82;
        background: white linear-gradient(0deg, white 0%, white 100%);
        /*font-weight: 500;*/
        -webkit-appearance: none;
      }
      select#listContainer[multiple] option:checked {
        color: #767D82;
        background: white linear-gradient(0deg, white 0%, white 100%);
        /*font-weight: 500;*/
        -webkit-appearance: none;
      }
    </style>

    <!-- STORE -->
    <iron-localstorage name="box:archive:items" value="{{items}}" on-iron-localstorage-load-empty="initializeArchiveItems"></iron-localstorage>
    <iron-localstorage name="box:auth:user" value="{{user}}" on-iron-localstorage-load-empty="initializeDefaultUser"></iron-localstorage>
    <!-- /STORE -->

    <!-- in darwin, ドラッグ可能なヘッダエリア -->
    <div id="draggableArea"></div>

    <div>検索</div>

    <select multiple id="listContainer" on-change="selectChange" tabindex="-1">
      <option class="item" value="" selected>新規アーカイブ</option>
      <template is="dom-repeat" items="{{items}}">
        <option class="item" value="{{item.key}}" id="{{item.key}}" data-name="{{item.name}}" on-contextmenu="openContextMenu">{{item.name}}</option>
      </template>
    </select>
  </template>


  <script>
    (() => {
      // <li class="item" on-click="itemClicked" on-contextmenu="openContextMenu" id="{{item.key}}" data-name="{{item.name}}">{{item.name}}</li>
      const electron = require('electron');
      const Menu = electron.remote.Menu;
      const menu = Menu.buildFromTemplate([
        {
          label: 'Copy download URL',
          click: (item) => {
            console.log(contextMenuTargetItem);
          },
        }, {
          type: 'separator'
        }, {
          label: 'Delete',
          click: (item) => {
            const uuid = firebase.auth().currentUser.uid;
            for (let item of selectedItems) {
              const entryKey = item.id;
              const entryName = item.dataName;
              const databaseRef = firebase.database().ref(`uploads/${uuid}/${entryKey}`);
              const storageRef = firebase.storage().ref().child(entryName);

              console.info(`[STORAGE DELETE]: ${entryName}...`);
              storageRef.delete().then(() => {
                console.info('[STORAGE DELETE]: complete');
                console.info(`[DATABASE DELETE]: ${entryKey}...`);
                return databaseRef.remove();
              }).then(() => {
                console.info('[DATABASE DELETE]: complete');
              }).catch((error) => {
                alert(`ERROR\n${error}`);
              });
            }
          },
        },
      ]);

      let contextMenuTargetItem = null;
      // 選択済みのアイテム
      let selectedItems = [];

      Polymer({
        is: 'box-archive-list',
        properties: {
          // user: Object,
          isOpened: Boolean,
          user: {
            type: Object,
          },
          items: {
            type: Array,
            value: function() {
              return [];
            }
          },
        },
        attached() {
          const uuid = this.user.uid;
          const uploadsRef = firebase.database().ref(`uploads/${uuid}`);
          uploadsRef.on('value', snapshot => {
            this.refresh(snapshot.val());
          });
        },
        refresh(entries) {
          // empty
          this.splice('items', 0, this.items.length);
          // add
          for (let key in entries) {
            let entry = entries[key];
            entry.key = key;
            this.push('items', entry);
          }
        },
        openContextMenu(event) {
          event.preventDefault();
          contextMenuTargetItem = event.target;
          // contextMenuTargetItem.classList.add('context');
          // setTimeout(() => {
          menu.popup(electron.remote.getCurrentWindow());
          // }, 5);
        },
        open() {
          this.isOpened = true;
        },
        close() {
          this.isOpened = false;
        },
        selectChange() {
          selectedItems = Polymer.dom(this.root).querySelectorAll('option.item:checked');
          this.fire('select-change', selectedItems);
        },
        getArchiveItemById(archiveId) {
          const item = this.items.filter(item => item.key === archiveId);
          if (item.length > 0) {
            return item[0];
          }
          return null;
        },
        initializeArchiveItems() {
          this.items = [];
        },
        initializeDefaultUser() {
          this.user = {
            uid: '',
            email: '',
            displayName: '',
          };
        },
      });

    })();
  </script>

</dom-module>
