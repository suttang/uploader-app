<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../components/drop-area.html">
<link rel="import" href="../components/box-file-list.html">
<link rel="import" href="../components/box-file-item.html">


<dom-module id="box-page-uploader">

  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        background: #f3f3f3;
      }
      strong {
          font-weight: 500;
      }
    </style>

    <button on-click="compress">compress</button>
    <box-file-list>
      <template is="dom-repeat" items="{{files}}">
        <box-file-item name="{{item.name}}" size="{{item.size}}">{{item.name}}</box-file-item>
      </template>
    </box-file-list>
    <p>
      Drop <strong>folder</strong> or <strong>files</strong> here
    </p>
    <!-- <box-drop-area id="uploadArea"></box-drop-area> -->

  </template>

  <script>

    const electron = require('electron');
    const fs = electron.remote.require('fs');
    const archiver = electron.remote.require('archiver');
    const archive = archiver('zip');
    const output = fs.createWriteStream('/Users/suttang/Desktop/archive_from_archiver.zip');

    const spawn = electron.remote.require('child_process').spawn;



    output.on('close', function() {
      console.log(archive.pointer() + ' total bytes');
      console.log('archiver has been finalized and the output file descriptor has closed.');
    });

    archive.on('entry', (event) => {
      console.log(event.stats.size);
    });
    let inputBytes = 0;
    let outputBytes = 0;
    let isInputMode = true;
    archive.on('data', (event) => {
      if (isInputMode) {
        inputBytes += event.length;
      } else {
        outputBytes += event.length;
      }
      // console.log(`${inputBytes} / ${outputBytes}`);
    });

    archive.on('error', function(err) {
      throw err;
    });

    archive.pipe(output);


    Polymer({
      is: 'box-page-uploader',
      listeners: {
        dragenter: 'handleDragEnter',
        dragover: 'handleDragOver',
        dragleave: 'handleDragLeave',
        drop: 'handleDrop',
      },
      properties: {
        files: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },
      handleDragEnter(event) {
          event.preventDefault();
          console.log("DRAG OVER");
      },
      handleDragOver(event) {
          event.preventDefault();
          console.log("DRAG OVER");
      },
      handleDragLeave(event) {
          event.preventDefault();
          console.log("DRAG LELAVE");
      },
      handleDrop(event) {
        event.preventDefault();
        let index = 0;
        for (let item of event.dataTransfer.items) {
          let entry = item.webkitGetAsEntry();
          let file = event.dataTransfer.files[index];
          console.log(file, entry);

          let size = spawn('du', ['-sh', file.path]);
          size.stdout.on('data', function (data) {
            console.log('size: ' + data);
          });

          if (entry.isFile) {
            archive.append(fs.createReadStream(file.path), { name: file.name });
          } else if (entry.isDirectory) {
            archive.directory(file.path, file.name, file);
          }
          this.push('files', {
            name: file.name,
            size: '1200',
          });
          index++;
        }
      },
      ready() {},
      compress() {
        isInputMode = false;
        archive.finalize();
        setInterval(() => {
          console.log(archive.pointer() + ' total bytes');
        }, 100);
      }
    });

  </script>

</dom-module>
